name: Benchmark Container Build Tools

on:
  workflow_dispatch:
    inputs:
      cache_scenario:
        description: 'Cache scenario'
        required: true
        default: 'cold'
        type: choice
        options: [cold, warm, dirty]
      run_number:
        description: 'Run number (1-5)'
        required: true
        default: '1'
        type: choice
        options: ['1', '2', '3', '4', '5']
  push:
    branches: [main]

env:
  CACHE_SCENARIO: ${{ github.event.inputs.cache_scenario || 'cold' }}
  RUN_NUMBER: ${{ github.event.inputs.run_number || '1' }}
  CI_SYSTEM: github-actions

jobs:
  # ==========================================================================
  # BUILDKIT
  # ==========================================================================
  buildkit:
    name: BuildKit (${{ matrix.service }}-${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [service-go, service-node, service-python]
        type: [baseline, optimized]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Clear Cache (Cold)
        if: env.CACHE_SCENARIO == 'cold'
        run: docker builder prune -af

      - name: Prime Cache (Warm)
        if: env.CACHE_SCENARIO == 'warm'
        run: |
          docker buildx build \
            --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
            --cache-to=type=gha,mode=max,scope=${{ matrix.service }}-${{ matrix.type }} \
            --load -t benchmark-image:latest ${{ matrix.service }}

      - name: Prime + Modify (Dirty)
        if: env.CACHE_SCENARIO == 'dirty'
        run: |
          docker buildx build \
            --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
            --cache-to=type=gha,mode=max,scope=${{ matrix.service }}-${{ matrix.type }} \
            --load ${{ matrix.service }}
          ./scripts/simulate_dirty_cache.sh ${{ matrix.service }}

      - name: Build with Metrics
        run: |
          ./scripts/measure_build.sh \
            buildkit ${{ matrix.service }} ${{ matrix.type }} \
            ${{ env.CACHE_SCENARIO }} ${{ env.RUN_NUMBER }} \
            docker buildx build \
              --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
              --cache-from=type=gha,scope=${{ matrix.service }}-${{ matrix.type }} \
              --cache-to=type=gha,mode=max,scope=${{ matrix.service }}-${{ matrix.type }} \
              --progress=plain --load -t benchmark-image:latest ${{ matrix.service }}

      - uses: actions/upload-artifact@v4
        with:
          name: results-buildkit-${{ matrix.service }}-${{ matrix.type }}-${{ env.CACHE_SCENARIO }}-run${{ env.RUN_NUMBER }}
          path: results/

  # ==========================================================================
  # KANIKO
  # ==========================================================================
  kaniko:
    name: Kaniko (${{ matrix.service }}-${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [service-go, service-node, service-python]
        type: [baseline, optimized]
    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Modify for Dirty Cache
        if: env.CACHE_SCENARIO == 'dirty'
        run: ./scripts/simulate_dirty_cache.sh ${{ matrix.service }}

      - name: Build with Metrics
        run: |
          mkdir -p results
          START_TIME=$(date +%s.%N)
          
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            gcr.io/kaniko-project/executor:latest \
            --dockerfile=/workspace/${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
            --context=dir:///workspace/${{ matrix.service }} \
            --verbosity=info \
            --no-push \
            --tarPath=/workspace/image.tar 2>&1 | tee /tmp/build.log || true
          
          END_TIME=$(date +%s.%N)
          DURATION=$(echo "$END_TIME - $START_TIME" | bc)
          
          # Image size from tarball
          IMAGE_SIZE_BYTES=$(stat -c%s image.tar 2>/dev/null || echo "0")
          
          # Cache parsing
          CACHE_HITS=$(grep -c "Using caching version" /tmp/build.log || echo "0")
          CACHE_TOTAL=$(grep -cE "^(RUN|COPY|ADD|FROM)" /tmp/build.log || echo "1")
          [ "$CACHE_TOTAL" -eq 0 ] && CACHE_TOTAL=1
          CACHE_HIT_RATIO=$(awk "BEGIN {printf \"%.4f\", $CACHE_HITS / $CACHE_TOTAL}")
          
          cat > results/kaniko_${{ matrix.service }}_${{ matrix.type }}_${{ env.CACHE_SCENARIO }}_run${{ env.RUN_NUMBER }}.json << EOF
          {
            "tool": "kaniko",
            "service": "${{ matrix.service }}",
            "dockerfile_type": "${{ matrix.type }}",
            "cache_scenario": "${{ env.CACHE_SCENARIO }}",
            "run_number": ${{ env.RUN_NUMBER }},
            "ci_system": "github-actions",
            "performance": {
              "build_duration_seconds": $DURATION,
              "cpu_percent": 0,
              "memory_peak_mb": 0,
              "image_size_bytes": $IMAGE_SIZE_BYTES,
              "cache_hits": $CACHE_HITS,
              "cache_total_steps": $CACHE_TOTAL,
              "cache_hit_ratio": $CACHE_HIT_RATIO
            }
          }
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: results-kaniko-${{ matrix.service }}-${{ matrix.type }}-${{ env.CACHE_SCENARIO }}-run${{ env.RUN_NUMBER }}
          path: results/

  # ==========================================================================
  # BUILDAH
  # ==========================================================================
  buildah:
    name: Buildah (${{ matrix.service }}-${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [service-go, service-node, service-python]
        type: [baseline, optimized]
    steps:
      - uses: actions/checkout@v4

      - name: Install Buildah
        run: sudo apt-get update && sudo apt-get install -y buildah

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Clear Cache (Cold)
        if: env.CACHE_SCENARIO == 'cold'
        run: buildah rm --all 2>/dev/null || true; buildah rmi --all -f 2>/dev/null || true

      - name: Prime Cache (Warm)
        if: env.CACHE_SCENARIO == 'warm'
        run: |
          buildah build --layers \
            --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
            -t benchmark-image:latest ${{ matrix.service }}

      - name: Prime + Modify (Dirty)
        if: env.CACHE_SCENARIO == 'dirty'
        run: |
          buildah build --layers \
            --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
            -t benchmark-image:latest ${{ matrix.service }}
          ./scripts/simulate_dirty_cache.sh ${{ matrix.service }}

      - name: Build with Metrics
        run: |
          ./scripts/measure_build.sh \
            buildah ${{ matrix.service }} ${{ matrix.type }} \
            ${{ env.CACHE_SCENARIO }} ${{ env.RUN_NUMBER }} \
            buildah build --layers \
              --file ${{ matrix.service }}/Dockerfile.${{ matrix.type }} \
              -t benchmark-image:latest ${{ matrix.service }}

      - uses: actions/upload-artifact@v4
        with:
          name: results-buildah-${{ matrix.service }}-${{ matrix.type }}-${{ env.CACHE_SCENARIO }}-run${{ env.RUN_NUMBER }}
          path: results/

  # ==========================================================================
  # SECURITY SCAN
  # ==========================================================================
  security:
    name: Security (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [buildkit]
    strategy:
      matrix:
        service: [service-go, service-node, service-python]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build for Scan
        run: |
          docker buildx build \
            --file ${{ matrix.service }}/Dockerfile.optimized \
            --load -t scan-image:latest ${{ matrix.service }}

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'json'
          output: 'trivy-${{ matrix.service }}.json'

      - name: SBOM Generation
        uses: anchore/sbom-action@v0
        with:
          image: scan-image:latest
          output-file: sbom-${{ matrix.service }}.spdx.json

      - uses: actions/upload-artifact@v4
        with:
          name: security-${{ matrix.service }}
          path: |
            trivy-${{ matrix.service }}.json
            sbom-${{ matrix.service }}.spdx.json

  # ==========================================================================
  # AGGREGATE
  # ==========================================================================
  aggregate:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: [buildkit, kaniko, buildah, security]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: all-results/

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Aggregate
        run: |
          mkdir -p final-results
          find all-results -name "*.json" -exec cp {} final-results/ \;
          export RESULTS_DIR=final-results
          python scripts/collect_metrics.py

      - uses: actions/upload-artifact@v4
        with:
          name: final-results-${{ env.CACHE_SCENARIO }}-run${{ env.RUN_NUMBER }}
          path: final-results/
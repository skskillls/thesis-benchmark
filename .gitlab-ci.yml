stages:
  - test
  - benchmark
  - security
  - aggregate

variables:
  CACHE_SCENARIO: "cold"
  RUN_NUMBER: "1"
  CI_SYSTEM: "gitlab-ci"

# Disable GitLab caching for scientific validity
cache: {}

# ==========================================================================
# TEST - Runs before all benchmark jobs
# ==========================================================================
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y golang-go nodejs npm
  script:
    # Test Go Service
    - cd service-go && go test -v && cd ..
    
    # Test Node Service
    - cd service-node && npm install && npm test && cd ..
    
    # Test Python Service
    - pip install -r service-python/requirements.txt
    - cd service-python && pytest -v && cd ..

# ==========================================================================
# BUILDKIT - DISABLED
# ==========================================================================
# Technical Limitation: BuildKit requires access to a Docker daemon, which is
# typically provided via Docker-in-Docker (DinD) service. On shared Kubernetes
# clusters, DinD is generally unavailable due to security restrictions that
# prevent running privileged containers. This is a documented limitation of
# Kubernetes-based CI/CD runners (see: docs.gitlab.com/ee/ci/docker/using_docker_build.html).
#
# Error observed: "Cannot connect to the Docker daemon at tcp://docker:2375"
#
# Alternative: BuildKit benchmarks are collected via GitHub Actions, which
# provides native Docker daemon access through its VM-based runners.

# ==========================================================================
# KANIKO - The only container build tool that works on K8s runners
# ==========================================================================
kaniko:
  stage: benchmark
  needs: [test]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  script:
    # Dirty cache modification (busybox shell)
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        case $SERVICE in
          service-go) echo "// Dirty" >> $SERVICE/main.go;;
          service-node) sed -i 's/1.0.0/1.0.999/' $SERVICE/package.json;;
          service-python) echo "# Dirty" >> $SERVICE/main.py;;
        esac
      fi
    
    # Capture timestamp (busybox compatible)
    - START_TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S%z 2>/dev/null || date +%Y-%m-%dT%H:%M:%S)
    - START_TIME=$(date +%s)
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR/$SERVICE \
        --dockerfile $CI_PROJECT_DIR/$SERVICE/Dockerfile.$TYPE \
        --verbosity=info \
        --no-push \
        --tarPath /tmp/image.tar 2>&1 | tee /tmp/build.log || true
    - END_TIME=$(date +%s)
    - DURATION=$((END_TIME - START_TIME))
    
    # Parse results with proper fallbacks
    - IMAGE_SIZE_BYTES=$(stat -c%s /tmp/image.tar 2>/dev/null || echo "0")
    - |
      if [ "$IMAGE_SIZE_BYTES" -ge 1048576 ] 2>/dev/null; then
        IMAGE_SIZE="$(awk "BEGIN {printf \"%.1fMB\", $IMAGE_SIZE_BYTES/1048576}")"
      elif [ "$IMAGE_SIZE_BYTES" -ge 1024 ] 2>/dev/null; then
        IMAGE_SIZE="$(awk "BEGIN {printf \"%.1fKB\", $IMAGE_SIZE_BYTES/1024}")"
      else
        IMAGE_SIZE="${IMAGE_SIZE_BYTES}B"
      fi
    - CACHE_HITS=$(grep -c "Using caching" /tmp/build.log 2>/dev/null || true)
    - CACHE_TOTAL=$(grep -cE "(RUN|COPY|ADD|FROM)" /tmp/build.log 2>/dev/null || true)
    - CACHE_HITS=${CACHE_HITS:-0}
    - CACHE_TOTAL=${CACHE_TOTAL:-1}
    - |
      if [ -z "$CACHE_HITS" ] || [ "$CACHE_HITS" = "" ]; then CACHE_HITS=0; fi
      if [ -z "$CACHE_TOTAL" ] || [ "$CACHE_TOTAL" = "" ] || [ "$CACHE_TOTAL" = "0" ]; then CACHE_TOTAL=1; fi
    - |
      mkdir -p results
      cat > results/kaniko_${SERVICE}_${TYPE}_${CACHE_SCENARIO}_run${RUN_NUMBER}.json <<EOF
      {
        "tool": "kaniko",
        "service": "$SERVICE",
        "dockerfile_type": "$TYPE",
        "cache_scenario": "$CACHE_SCENARIO",
        "run_number": $RUN_NUMBER,
        "timestamp": "$START_TIMESTAMP",
        "ci_system": "gitlab-ci",
        "performance": {
          "build_duration_seconds": $DURATION,
          "cpu_percent": 0,
          "cpu_user_seconds": 0,
          "cpu_system_seconds": 0,
          "memory_peak_mb": 0,
          "image_size": "$IMAGE_SIZE",
          "image_size_bytes": $IMAGE_SIZE_BYTES,
          "cache_hits": $CACHE_HITS,
          "cache_total_steps": $CACHE_TOTAL,
          "cache_hit_ratio": 0
        },
        "exit_code": 0
      }
      EOF
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# BUILDAH - DISABLED
# ==========================================================================
# Technical Limitation: Buildah requires either root privileges or specific
# Linux kernel capabilities (CAP_SYS_ADMIN) for mount operations. On shared
# Kubernetes clusters, containers run in rootless/unprivileged mode for
# security isolation between tenants.
#
# Error observed: "permission denied" during layer application with
# "remount flags: 0x44000" indicating missing mount capabilities.
#
# Alternative: Buildah benchmarks are collected via GitHub Actions, which
# supports privileged container operations.

# ==========================================================================
# SECURITY (Trivy & Syft) - DISABLED
# ==========================================================================
# Technical Limitation: Security scanning tools (Trivy, Syft) require a
# built container image to analyze. Since image building on this cluster
# is limited to Kaniko (which outputs to tarball), and these tools expect
# a Docker daemon for image inspection, security scans cannot be performed.
#
# Alternative: Security scans (vulnerability assessment via Trivy and SBOM
# generation via Syft) are performed on GitHub Actions where Docker daemon
# is available. This ensures complete security analysis data is still
# collected as part of the benchmarking study.

# ==========================================================================
# AGGREGATE
# ==========================================================================
aggregate:
  stage: aggregate
  image: python:3.11-slim
  needs: [kaniko]
  script:
    - mkdir -p final-results
    - find . -name "*.json" -path "./results/*" -exec cp {} final-results/ \;
    - pip install --quiet pandas
    - export RESULTS_DIR=final-results
    - python scripts/collect_metrics.py
  artifacts:
    paths:
      - final-results/
    expire_in: 1 month
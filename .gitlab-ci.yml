stages:
  - benchmark
  - security
  - aggregate

variables:
  CACHE_SCENARIO: "cold"
  RUN_NUMBER: "1"
  CI_SYSTEM: "gitlab-ci"

# Disable GitLab caching for scientific validity
cache: {}

# ==========================================================================
# BUILDKIT
# ==========================================================================
buildkit:
  stage: benchmark
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_BUILDKIT: 1
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  script:
    - apk add --no-cache bash bc coreutils
    - chmod +x scripts/*.sh
    - sleep 5
    
    # Scenario handling
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        docker build --file $SERVICE/Dockerfile.$TYPE -t benchmark-image:latest $SERVICE
        ./scripts/simulate_dirty_cache.sh $SERVICE
      fi
    
    # Build with metrics
    - |
      ./scripts/measure_build.sh \
        buildkit $SERVICE $TYPE $CACHE_SCENARIO $RUN_NUMBER \
        docker build --progress=plain \
          --file $SERVICE/Dockerfile.$TYPE \
          -t benchmark-image:latest $SERVICE
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# KANIKO
# ==========================================================================
kaniko:
  stage: benchmark
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  script:
    # Dirty cache modification (busybox shell)
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        case $SERVICE in
          service-go) echo "// Dirty" >> $SERVICE/main.go;;
          service-node) sed -i 's/1.0.0/1.0.999/' $SERVICE/package.json;;
          service-python) echo "# Dirty" >> $SERVICE/requirements.txt;;
        esac
      fi
    
    # Capture timestamp (busybox compatible)
    - START_TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S%z 2>/dev/null || date +%Y-%m-%dT%H:%M:%S)
    - START_TIME=$(date +%s)
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR/$SERVICE \
        --dockerfile $CI_PROJECT_DIR/$SERVICE/Dockerfile.$TYPE \
        --verbosity=info \
        --no-push \
        --tarPath /tmp/image.tar 2>&1 | tee /tmp/build.log || true
    - END_TIME=$(date +%s)
    - DURATION=$((END_TIME - START_TIME))
    
    # Parse results with proper fallbacks
    - IMAGE_SIZE_BYTES=$(stat -c%s /tmp/image.tar 2>/dev/null || echo "0")
    - IMAGE_SIZE="${IMAGE_SIZE_BYTES}B"
    - CACHE_HITS=$(grep -c "Using caching" /tmp/build.log 2>/dev/null || true)
    - CACHE_TOTAL=$(grep -cE "(RUN|COPY|ADD|FROM)" /tmp/build.log 2>/dev/null || true)
    - CACHE_HITS=${CACHE_HITS:-0}
    - CACHE_TOTAL=${CACHE_TOTAL:-1}
    - |
      if [ -z "$CACHE_HITS" ] || [ "$CACHE_HITS" = "" ]; then CACHE_HITS=0; fi
      if [ -z "$CACHE_TOTAL" ] || [ "$CACHE_TOTAL" = "" ] || [ "$CACHE_TOTAL" = "0" ]; then CACHE_TOTAL=1; fi
    - |
      mkdir -p results
      cat > results/kaniko_${SERVICE}_${TYPE}_${CACHE_SCENARIO}_run${RUN_NUMBER}.json << EOF
      {
        "tool": "kaniko",
        "service": "$SERVICE",
        "dockerfile_type": "$TYPE",
        "cache_scenario": "$CACHE_SCENARIO",
        "run_number": $RUN_NUMBER,
        "timestamp": "$START_TIMESTAMP",
        "ci_system": "gitlab-ci",
        "performance": {
          "build_duration_seconds": $DURATION,
          "cpu_percent": 0,
          "cpu_user_seconds": 0,
          "cpu_system_seconds": 0,
          "memory_peak_mb": 0,
          "image_size": "$IMAGE_SIZE",
          "image_size_bytes": $IMAGE_SIZE_BYTES,
          "cache_hits": $CACHE_HITS,
          "cache_total_steps": $CACHE_TOTAL,
          "cache_hit_ratio": 0
        },
        "exit_code": 0
      }
      EOF
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# BUILDAH
# ==========================================================================
buildah:
  stage: benchmark
  image: quay.io/buildah/stable
  variables:
    BUILDAH_ISOLATION: chroot
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  script:
    - dnf install -y time bc 2>/dev/null || true
    - chmod +x scripts/*.sh
    
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        buildah build --storage-driver=vfs --layers \
          --file $SERVICE/Dockerfile.$TYPE -t benchmark-image:latest $SERVICE || true
        ./scripts/simulate_dirty_cache.sh $SERVICE
      fi
    
    - |
      ./scripts/measure_build.sh \
        buildah $SERVICE $TYPE $CACHE_SCENARIO $RUN_NUMBER \
        buildah build --storage-driver=vfs --layers \
          --file $SERVICE/Dockerfile.$TYPE \
          -t benchmark-image:latest $SERVICE
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# SECURITY
# ==========================================================================
security:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
  script:
    - apk add --no-cache curl
    - sleep 5
    - docker build --file $SERVICE/Dockerfile.optimized -t scan-image:latest $SERVICE
    
    # Trivy
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --format json -o trivy-${SERVICE}.json scan-image:latest
    
    # Syft SBOM
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    - syft scan-image:latest -o spdx-json > sbom-${SERVICE}.spdx.json
  artifacts:
    paths:
      - trivy-*.json
      - sbom-*.spdx.json
    expire_in: 1 week

# ==========================================================================
# AGGREGATE
# ==========================================================================
aggregate:
  stage: aggregate
  image: python:3.11-slim
  needs: [buildkit, kaniko, buildah, security]
  script:
    - mkdir -p final-results
    - find . -name "*.json" -path "./results/*" -exec cp {} final-results/ \;
    - pip install --quiet pandas
    - export RESULTS_DIR=final-results
    - python scripts/collect_metrics.py
  artifacts:
    paths:
      - final-results/
    expire_in: 1 month
stages:
  - test
  - benchmark
  - security
  - aggregate

variables:
  CACHE_SCENARIO: "cold"
  RUN_NUMBER: "1"
  CI_SYSTEM: "gitlab-ci"
  RUN_SECURITY: "false"

# Disable GitLab caching for scientific validity
cache: {}

# ==========================================================================
# TEST - Runs before all benchmark jobs
# ==========================================================================
test:
  stage: test
  image: python:3.9-slim
  before_script:
    - apt-get update && apt-get install -y curl
    # Install Go 1.21
    - curl -LO https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
    - tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
    - export PATH=$PATH:/usr/local/go/bin
    # Install Node.js 18
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
  script:
    # Test Go Service
    - export PATH=$PATH:/usr/local/go/bin
    - cd service-go && go test -v && cd ..
    
    # Test Node Service
    - cd service-node && npm install && npm test && cd ..
    
    # Test Python Service
    - pip install -r service-python/requirements.txt
    - cd service-python && pytest -v && cd ..

# ==========================================================================
# BUILDKIT
# ==========================================================================
buildkit:
  stage: benchmark
  needs: [test]
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  before_script:
    - apk add --no-cache bash bc coreutils
    - chmod +x scripts/*.sh
    - until docker info; do sleep 1; done
    - docker buildx create --use
  script:
    # Clear Cache (Cold)
    - |
      if [ "$CACHE_SCENARIO" = "cold" ]; then
        docker builder prune -af
      fi
    
    # Prime Cache (Warm)
    - |
      if [ "$CACHE_SCENARIO" = "warm" ]; then
        docker buildx build \
          --file $SERVICE/Dockerfile.$TYPE \
          --load -t benchmark-image:latest $SERVICE
      fi
    
    # Prime + Modify (Dirty)
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        docker buildx build \
          --file $SERVICE/Dockerfile.$TYPE \
          --load $SERVICE
        ./scripts/simulate_dirty_cache.sh $SERVICE
      fi
    
    # Build with Metrics
    - |
      ./scripts/measure_build.sh \
        buildkit $SERVICE $TYPE \
        $CACHE_SCENARIO $RUN_NUMBER \
        docker buildx build \
          --file $SERVICE/Dockerfile.$TYPE \
          --progress=plain --load -t benchmark-image:latest $SERVICE
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# KANIKO
# ==========================================================================
kaniko:
  stage: benchmark
  needs: [test]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  script:
    # Dirty cache modification (busybox shell)
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        case $SERVICE in
          service-go) echo "// Dirty" >> $SERVICE/main.go;;
          service-node) sed -i 's/1.0.0/1.0.999/' $SERVICE/package.json;;
          service-python) echo "# Dirty" >> $SERVICE/main.py;;
        esac
      fi
    
    # Capture timestamp (busybox compatible)
    - START_TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S%z 2>/dev/null || date +%Y-%m-%dT%H:%M:%S)
    - START_TIME=$(date +%s)
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR/$SERVICE \
        --dockerfile $CI_PROJECT_DIR/$SERVICE/Dockerfile.$TYPE \
        --verbosity=info \
        --no-push \
        --tarPath /tmp/image.tar 2>&1 | tee /tmp/build.log || true
    - END_TIME=$(date +%s)
    - DURATION=$((END_TIME - START_TIME))
    
    # Parse results with proper fallbacks
    - IMAGE_SIZE_BYTES=$(stat -c%s /tmp/image.tar 2>/dev/null || echo "0")
    - |
      if [ "$IMAGE_SIZE_BYTES" -ge 1048576 ] 2>/dev/null; then
        IMAGE_SIZE="$(awk "BEGIN {printf \"%.1fMB\", $IMAGE_SIZE_BYTES/1048576}")"
      elif [ "$IMAGE_SIZE_BYTES" -ge 1024 ] 2>/dev/null; then
        IMAGE_SIZE="$(awk "BEGIN {printf \"%.1fKB\", $IMAGE_SIZE_BYTES/1024}")"
      else
        IMAGE_SIZE="${IMAGE_SIZE_BYTES}B"
      fi
    - CACHE_HITS=$(grep -c "Using caching" /tmp/build.log 2>/dev/null || true)
    - CACHE_TOTAL=$(grep -cE "(RUN|COPY|ADD|FROM)" /tmp/build.log 2>/dev/null || true)
    - CACHE_HITS=${CACHE_HITS:-0}
    - CACHE_TOTAL=${CACHE_TOTAL:-1}
    - |
      if [ -z "$CACHE_HITS" ] || [ "$CACHE_HITS" = "" ]; then CACHE_HITS=0; fi
      if [ -z "$CACHE_TOTAL" ] || [ "$CACHE_TOTAL" = "" ] || [ "$CACHE_TOTAL" = "0" ]; then CACHE_TOTAL=1; fi
    - |
      mkdir -p results
      cat > results/kaniko_${SERVICE}_${TYPE}_${CACHE_SCENARIO}_run${RUN_NUMBER}.json <<EOF
      {
        "tool": "kaniko",
        "service": "$SERVICE",
        "dockerfile_type": "$TYPE",
        "cache_scenario": "$CACHE_SCENARIO",
        "run_number": $RUN_NUMBER,
        "timestamp": "$START_TIMESTAMP",
        "ci_system": "gitlab-ci",
        "performance": {
          "build_duration_seconds": $DURATION,
          "cpu_percent": 0,
          "cpu_user_seconds": 0,
          "cpu_system_seconds": 0,
          "memory_peak_mb": 0,
          "image_size": "$IMAGE_SIZE",
          "image_size_bytes": $IMAGE_SIZE_BYTES,
          "cache_hits": $CACHE_HITS,
          "cache_total_steps": $CACHE_TOTAL,
          "cache_hit_ratio": 0
        },
        "exit_code": 0
      }
      EOF
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# BUILDAH
# ==========================================================================
buildah:
  stage: benchmark
  needs: [test]
  image: quay.io/buildah/stable
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_ISOLATION: chroot
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
        TYPE: [baseline, optimized]
  before_script:
    - dnf install -y bc time || yum install -y bc time || true
    - chmod +x scripts/*.sh
  script:
    # Clear Cache (Cold)
    - |
      if [ "$CACHE_SCENARIO" = "cold" ]; then
        buildah rm --all 2>/dev/null || true
        buildah rmi --all -f 2>/dev/null || true
      fi
    
    # Prime Cache (Warm)
    - |
      if [ "$CACHE_SCENARIO" = "warm" ]; then
        buildah build --layers \
          --file $SERVICE/Dockerfile.$TYPE \
          -t benchmark-image:latest $SERVICE
      fi
    
    # Prime + Modify (Dirty)
    - |
      if [ "$CACHE_SCENARIO" = "dirty" ]; then
        buildah build --layers \
          --file $SERVICE/Dockerfile.$TYPE \
          -t benchmark-image:latest $SERVICE
        ./scripts/simulate_dirty_cache.sh $SERVICE
      fi
    
    # Build with Metrics
    - |
      ./scripts/measure_build.sh \
        buildah $SERVICE $TYPE \
        $CACHE_SCENARIO $RUN_NUMBER \
        buildah build --layers \
          --file $SERVICE/Dockerfile.$TYPE \
          -t benchmark-image:latest $SERVICE
  artifacts:
    paths: [results/]
    expire_in: 1 week

# ==========================================================================
# SECURITY SCAN
# ==========================================================================
security:
  stage: security
  needs: [buildkit]
  rules:
    - if: $RUN_SECURITY == "true"
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  parallel:
    matrix:
      - SERVICE: [service-go, service-node, service-python]
  before_script:
    - apk add --no-cache curl
    # Wait for Docker daemon to be ready
    - until docker info; do sleep 1; done
    # Install Trivy
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    # Install Syft
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
  script:
    # Build image for scanning
    - |
      docker buildx create --use --name scanner 2>/dev/null || true
      docker buildx build \
        --file $SERVICE/Dockerfile.optimized \
        --load -t scan-image:latest $SERVICE
    
    # Trivy Scan
    - trivy image --format json -o trivy-$SERVICE.json scan-image:latest || true
    
    # SBOM Generation with Syft
    - syft scan-image:latest -o spdx-json > sbom-$SERVICE.spdx.json || true
  artifacts:
    paths:
      - trivy-*.json
      - sbom-*.spdx.json
    expire_in: 1 week

# ==========================================================================
# AGGREGATE
# ==========================================================================
aggregate:
  stage: aggregate
  image: python:3.11-slim
  needs:
    - job: buildkit
      optional: true
    - job: kaniko
      optional: true
    - job: buildah
      optional: true
    - job: security
      optional: true
  script:
    - mkdir -p final-results-gitlab-public-${CACHE_SCENARIO}-run${RUN_NUMBER}
    - find . -name "*.json" -path "./results/*" -exec cp {} final-results-gitlab-public-${CACHE_SCENARIO}-run${RUN_NUMBER}/ \;
    - pip install --quiet pandas
    - export RESULTS_DIR=final-results-gitlab-public-${CACHE_SCENARIO}-run${RUN_NUMBER}
    - python scripts/collect_metrics.py
  artifacts:
    paths:
      - final-results-gitlab-public-${CACHE_SCENARIO}-run${RUN_NUMBER}/
    expire_in: 1 month